# BLE 印表機模擬器 - 最新進度

**日期**: 2026-01-18
**狀態**: 連線成功，但有 SMP Security Request 問題

---

## 目標
讓 Raspberry Pi 模擬 BT-B36 熱感印表機的 BLE 行為，使 App 能連線並發送列印資料。

---

## 當前狀態

### 已成功
- GATT Server 建立完成（7 個 Service）
- nRF Connect 可掃描到 "BT-B36"
- **連線實際上是成功的**（btmon 顯示 LE Connection Complete）
- GATT 服務發現完成，所有服務都被正確列出

### 問題
**BlueZ 仍發送 `SMP: Security Request`**，導致：
- nRF Connect 可能彈出配對請求或顯示連線失敗
- 這是 BlueZ 核心行為，無法透過 `--noplugin` 或 `btmgmt` 完全禁用

---

## 已嘗試的設定

| 設定 | 結果 |
|------|------|
| `btmgmt bondable off` | ✓ 成功禁用 |
| `btmgmt sc off` | ✓ 成功禁用 |
| `btmgmt ssp off` | ✗ Rejected（BLE 模式不支援）|
| `Pairable = False` (D-Bus) | ✓ 已設定 |
| `SecureConnections = off` (main.conf) | ✓ 已設定 |
| `Client = false` (main.conf [GATT]) | ✗ 內建服務仍存在 |
| `--noplugin=mcp,vcp,bap...` | ✗ 這些是核心功能，非 plugin |

---

## 關鍵檔案

```
source/
├── start_printer_v7.sh    # 最新啟動腳本（推薦）
├── main_hci_v4.py         # 最新 Python 程式（Pairable=False）
├── main_bless.py          # 替代方案（使用 bless 庫）
└── main.conf.v2           # 推薦的 BlueZ 配置
```

---

## 下一步建議

1. **測試配對流程**
   執行 `sudo ./start_printer_v7.sh`，當 nRF Connect 彈出配對請求時**點擊「配對」**，應可完成 Just Works 配對。

2. **如仍失敗，確認 nRF Connect 錯誤訊息**
   - Connection timeout?
   - GATT Error?
   - Pairing failed?

3. **終極方案（如需完全禁用 SMP）**
   - 使用修改過的 BlueZ 或
   - 使用 HCI 直接控制（繞過 bluetoothd）

---

## btmon 分析重點

成功連線的 log 特徵：
```
LE Connection Complete - Status: Success
SMP: Security Request (0x0b)  ← 這是問題來源
ATT: Read By Group Type Response  ← GATT 發現成功
```

如看到 `Insufficient Authentication (0x05)`，表示內建服務要求認證。
如看到 `Attribute Not Found (0x0a)`，這是正常的（表示該屬性不存在）。

---

## 參考 Log 檔案

- `logs/v6 btmon log.txt` - 最新測試的 btmon 輸出
- `logs/v6 printer log.txt` - 最新測試的程式輸出
