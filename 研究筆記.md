# Raspberry Pi BLE ç†±æ„Ÿå°è¡¨æ©Ÿæ¨¡æ“¬å™¨ - ç ”ç©¶ç­†è¨˜

> **ç›®æ¨™**ï¼šè®“ Raspberry Pi å®Œå…¨æ¨¡æ“¬ BT-B36 ç†±æ„Ÿå°è¡¨æ©Ÿçš„ BLE è¡Œç‚º
> **æ—¥æœŸ**ï¼š2026-01-17ï¼ˆæ›´æ–°ï¼‰
> **ç‹€æ…‹**ï¼šé€²è¡Œä¸­ - é…å°å•é¡Œå·²è§£æ±º

---

## ğŸ“‹ åŸæ©Ÿè¦æ ¼ï¼ˆBT-B36ï¼‰

| é …ç›® | å€¼ |
|------|-----|
| è£ç½®åç¨± | BT-B36 |
| MAC | 10:23:81:3F:89:B5 |
| ä¸»è¦å¯«å…¥ UUID | 0000ff02-0000-1000-8000-00805f9b34fb |
| ä¸»è¦é€šçŸ¥ UUID | 0000ff01-0000-1000-8000-00805f9b34fb |
| é€šè¨Šå”å®š | ESC/POS |
| Service æ•¸é‡ | 7 å€‹ |

### GATT çµæ§‹
```
â”œâ”€â”€ 0xFF00: Primary Print Service (FF01/FF02/FF03)
â”œâ”€â”€ 0xFF10: Secondary Print Service (FF11/FF12)
â”œâ”€â”€ 0xEEE0: Custom Service (EEE1)
â”œâ”€â”€ UART: Microchip UART Service (49535343-...)
â”œâ”€â”€ 0x18F0: Unknown Service (2AF0/2AF1)
â”œâ”€â”€ E781...: Unknown Service (BEF8...)
â””â”€â”€ 0x180A: Device Information Service
```

---

## âœ… é–‹ç™¼é€²åº¦

### å·²å®Œæˆ
- [x] åŸæ©Ÿ BLE æƒæèˆ‡åˆ†æ
- [x] GATT Server æ¶æ§‹è¨­è¨ˆï¼ˆ7 å€‹ Serviceï¼‰
- [x] ESC/POS æŒ‡ä»¤è§£æå™¨
- [x] ç‹€æ…‹æŸ¥è©¢å›æ‡‰ï¼ˆDLE EOT, GS r, GS Iï¼‰
- [x] BlueZ D-Bus API æ•´åˆ
- [x] BLE å»£æ’­è¨­å®šï¼ˆä½¿ç”¨ btmgmtï¼‰
- [x] nRF Connect é€£ç·šæ¸¬è©¦æˆåŠŸ
- [x] è³‡æ–™å¯«å…¥èˆ‡ Notify å›æ‡‰æˆåŠŸ
- [x] **è§£æ±ºé…å°å•é¡Œï¼ˆNoInputNoOutput Agentï¼‰**

### é€²è¡Œä¸­
- [ ] App é€£ç·šæ¸¬è©¦ï¼ˆESCPOS Bluetooth Print Serviceï¼‰

### å°šæœªé–‹å§‹
- [ ] å®Œæ•´ ESC/POS æŒ‡ä»¤æ¨¡æ“¬
- [ ] åœ–ç‰‡åˆ—å°è³‡æ–™è§£æ
- [ ] å» å•†ç§æœ‰å”å®šåˆ†æ

---

## ğŸ”‘ é…å°å•é¡Œè§£æ±ºæ–¹æ¡ˆï¼ˆ2026-01-17ï¼‰

### å•é¡Œæè¿°
BlueZ é è¨­æœƒåœ¨ BLE é€£ç·šæ™‚ç™¼é€ `SMP: Security Request`ï¼Œè¦æ±‚å®¢æˆ¶ç«¯é€²è¡Œé…å°èªè­‰ã€‚é€™å°è‡´ï¼š
1. btmon é¡¯ç¤º `Error: Insufficient Authentication (0x05)`
2. App é€£ç·šæ™‚å½ˆå‡ºé…å°è«‹æ±‚
3. æŸäº› App ç„¡æ³•æ­£ç¢ºè™•ç†é…å°æµç¨‹

### è§£æ±ºæ–¹æ¡ˆ

#### æ–¹æ¡ˆ 1: NoInputNoOutput Agentï¼ˆæ¨è–¦ï¼‰
åœ¨ç¨‹å¼ä¸­è¨»å†Šä¸€å€‹ NoInputNoOutput Agentï¼Œè‡ªå‹•æ¥å—æ‰€æœ‰é…å°è«‹æ±‚ï¼š

```python
AGENT_IFACE = 'org.bluez.Agent1'
AGENT_MANAGER_IFACE = 'org.bluez.AgentManager1'
AGENT_PATH = "/org/bluez/printer_agent"

class NoInputNoOutputAgent(dbus.service.Object):
    @dbus.service.method(AGENT_IFACE, in_signature="o", out_signature="")
    def RequestAuthorization(self, device):
        # è‡ªå‹•æˆæ¬Š
        return
    
    @dbus.service.method(AGENT_IFACE, in_signature="ou", out_signature="")
    def RequestConfirmation(self, device, passkey):
        # è‡ªå‹•ç¢ºèª
        return
    
    # ... å…¶ä»–æ–¹æ³•

# è¨»å†Š Agent
agent = NoInputNoOutputAgent(bus, AGENT_PATH)
agent_manager = dbus.Interface(
    bus.get_object(BLUEZ_SERVICE, "/org/bluez"),
    AGENT_MANAGER_IFACE)
agent_manager.RegisterAgent(AGENT_PATH, "NoInputNoOutput")
agent_manager.RequestDefaultAgent(AGENT_PATH)
```

#### æ–¹æ¡ˆ 2: btmgmt è¨­å®š
```bash
# é—œé–‰ bondable
sudo btmgmt bondable no

# é—œé–‰ Secure Connections
sudo btmgmt sc off

# è¨­å®š IO capability ç‚º NoInputNoOutput
sudo btmgmt io-cap 3

# å•Ÿç”¨å¯ç™¼ç¾å’Œå¯é€£æ¥
sudo btmgmt discov yes
sudo btmgmt connectable yes
```

#### æ–¹æ¡ˆ 3: BlueZ é…ç½®æª”ï¼ˆ/etc/bluetooth/main.confï¼‰
```ini
[General]
Name = BT-B36
Pairable = true
PairableTimeout = 0
DiscoverableTimeout = 0
JustWorksRepairing = always
FastConnectable = true

[Policy]
AutoEnable = true
```

#### æ–¹æ¡ˆ 4: å•Ÿå‹• bluetoothd æ™‚åœç”¨ plugin
```bash
# åœç”¨ sap å’Œ input plugin
sudo /usr/libexec/bluetooth/bluetoothd --noplugin=sap,input
```

### æœ€çµ‚æ¡ç”¨
çµåˆæ–¹æ¡ˆ 1 + 2 + 4ï¼Œå»ºç«‹ `main_hci_v2.py`ï¼š
- ç¨‹å¼å…§è¨»å†Š NoInputNoOutput Agent
- ä½¿ç”¨ btmgmt è¨­å®š bondable=no, sc=off, io-cap=3
- å•Ÿå‹•æ™‚åœç”¨ä¸å¿…è¦çš„ plugin

---

## ğŸ› é‡åˆ°çš„å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆ

### 1. BlueZ Advertisement API è¨»å†Šå¤±æ•—
**éŒ¯èª¤è¨Šæ¯**ï¼š
```
Failed to register advertisement: org.bluez.Error.Failed
```

**åŸå› **ï¼šä¹‹å‰çš„å»£æ’­å¯¦ä¾‹æœªæ­£ç¢ºé‡‹æ”¾ï¼Œä½”ç”¨äº†å»£æ’­æ§½ä½

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```bash
# æ–¹æ¡ˆ Aï¼šé‡å•Ÿè—ç‰™æœå‹™
sudo systemctl restart bluetooth

# æ–¹æ¡ˆ Bï¼šä½¿ç”¨ btmgmt
sudo btmgmt power off
sudo btmgmt power on

# æ–¹æ¡ˆ Cï¼ˆæ¡ç”¨ï¼‰ï¼šæ”¹ç”¨ btmgmt è¨­å®šå»£æ’­ï¼Œä¸ä½¿ç”¨ Advertisement API
```

---

### 2. RF-kill å°é–è—ç‰™
**éŒ¯èª¤è¨Šæ¯**ï¼š
```
Can't init device hci0: Operation not possible due to RF-kill (132)
```

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```bash
sudo rfkill unblock bluetooth
```

---

### 3. hciconfig piscan ä¸æ”¯æ´
**éŒ¯èª¤è¨Šæ¯**ï¼š
```
Can't set scan mode on hci0: Operation not supported (95)
```

**åŸå› **ï¼š`piscan` æ˜¯ Classic Bluetooth æŒ‡ä»¤ï¼Œåœ¨ç´” BLE æ¨¡å¼ä¸‹ä¸æ”¯æ´

**è§£æ±ºæ–¹æ¡ˆ**ï¼šæ”¹ç”¨ `btmgmt` æŒ‡ä»¤
```bash
sudo btmgmt discov yes
sudo btmgmt connectable yes
sudo btmgmt advertising on
```

---

### 4. GATT è®€å–éœ€è¦èªè­‰ï¼ˆå·²è§£æ±ºï¼‰
**éŒ¯èª¤è¨Šæ¯**ï¼ˆbtmonï¼‰ï¼š
```
ATT: Error Response (0x01)
  Handle: 0x0030
  Error: Insufficient Authentication (0x05)
```

**åŸå› **ï¼šBlueZ é è¨­æœƒç™¼é€ `SMP: Security Request`ï¼Œè¦æ±‚é…å°å¾Œæ‰èƒ½å­˜å– GATT

**è§£æ±ºæ–¹æ¡ˆ**ï¼šè¦‹ä¸Šæ–¹ã€Œé…å°å•é¡Œè§£æ±ºæ–¹æ¡ˆã€

---

### 5. æ—¥èªŒæª”è·¯å¾‘éŒ¯èª¤
**éŒ¯èª¤è¨Šæ¯**ï¼š
```
FileNotFoundError: No such file or directory: '/home/pi/ble_printer_emulator/printer_data.log'
```

**è§£æ±ºæ–¹æ¡ˆ**ï¼šä½¿ç”¨ç›¸å°è·¯å¾‘æˆ–å‹•æ…‹å–å¾—è…³æœ¬ç›®éŒ„
```python
import os
SCRIPT_DIR = os.path.dirname(os.path.abspath(__file__))
LOG_FILE = os.path.join(SCRIPT_DIR, "printer_data.log")
```

---

## âš ï¸ æ‡‰è©²é¿å…çš„éŒ¯èª¤

### ç¨‹å¼è¨­è¨ˆ
1. **ä¸è¦ç¡¬ç·¨ç¢¼çµ•å°è·¯å¾‘** - ä½¿ç”¨ `os.path` å‹•æ…‹ç”¢ç”Ÿ
2. **ä¸è¦å‡è¨­ BlueZ Advertisement API å¯ç”¨** - æŸäº›ç’°å¢ƒä¸‹æœƒå¤±æ•—ï¼Œéœ€è¦å‚™æ¡ˆ
3. **Characteristic çš„ CCCD (0x2902) ä¸è¦é‡è¤‡åŠ å…¥** - æœƒé€ æˆ nRF Connect é¡¯ç¤ºç•°å¸¸
4. **ä¸€å®šè¦è¨»å†Š Agent** - å¦å‰‡ BlueZ æœƒå¼·åˆ¶è¦æ±‚é…å°

### BlueZ è¨­å®š
1. **ä¸è¦ä½¿ç”¨ `hciconfig piscan`** - BLE æ¨¡å¼ä¸æ”¯æ´
2. **ä¸è¦å¿½ç•¥ RF-kill** - é‡å•Ÿå¾Œå¯èƒ½è¢«å°é–
3. **æ³¨æ„ BlueZ ç‰ˆæœ¬å·®ç•°** - ä¸åŒç‰ˆæœ¬çš„ API è¡Œç‚ºå¯èƒ½ä¸åŒ
4. **è¨­å®š bondable=no å’Œ sc=off** - é¿å…å¼·åˆ¶é…å°

### æ¸¬è©¦æµç¨‹
1. **å…ˆç”¨ nRF Connect æ¸¬è©¦** - å†ç”¨å¯¦éš› App
2. **é–‹å•Ÿ btmon ç›£æ§** - å¯ä»¥çœ‹åˆ°åº•å±¤é€šè¨Šç´°ç¯€
3. **æª¢æŸ¥ console è¼¸å‡º** - ç¢ºèª WriteValue æ˜¯å¦è¢«å‘¼å«
4. **æª¢æŸ¥ Agent æ˜¯å¦è¢«å‘¼å«** - ç¢ºèªé…å°è«‹æ±‚æœ‰è¢«è™•ç†

---

## ğŸ”§ é—œéµæŒ‡ä»¤å‚™å¿˜

### è—ç‰™ç‹€æ…‹æª¢æŸ¥
```bash
hciconfig hci0                    # æª¢æŸ¥ adapter ç‹€æ…‹
sudo btmgmt info                  # æª¢æŸ¥è©³ç´°è¨­å®š
rfkill list                       # æª¢æŸ¥ RF-kill ç‹€æ…‹
sudo btmon                        # ç›£æ§è—ç‰™é€šè¨Š
```

### è—ç‰™é‡å•Ÿ
```bash
sudo systemctl restart bluetooth
sudo rfkill unblock bluetooth
sudo hciconfig hci0 up
```

### å»£æ’­è¨­å®šï¼ˆå®Œæ•´ç‰ˆï¼‰
```bash
sudo btmgmt power on
sudo btmgmt discov yes
sudo btmgmt connectable yes
sudo btmgmt bondable no           # é¿å…é…å°è¦æ±‚
sudo btmgmt sc off                # é—œé–‰ Secure Connections
sudo btmgmt io-cap 3              # NoInputNoOutput
sudo btmgmt advertising on
```

### é™¤éŒ¯æ¨¡å¼å•Ÿå‹• bluetoothd
```bash
# åœæ­¢ç³»çµ±æœå‹™
sudo systemctl stop bluetooth

# æ–¹å¼ 1: ä¸€èˆ¬é™¤éŒ¯
sudo /usr/libexec/bluetooth/bluetoothd -n -d

# æ–¹å¼ 2: åœç”¨æŸäº› plugin
sudo /usr/libexec/bluetooth/bluetoothd -n -d --noplugin=sap,input

# æ–¹å¼ 3: å•Ÿç”¨å¯¦é©—åŠŸèƒ½
sudo /usr/libexec/bluetooth/bluetoothd -n -d -E
```

---

## ğŸ“ æª”æ¡ˆçµæ§‹

```
ble_printer_emulator/
â”œâ”€â”€ main_hci.py              # åŸå§‹ç‰ˆæœ¬
â”œâ”€â”€ main_hci_v2.py           # æ–°ç‰ˆï¼ˆå« NoInputNoOutput Agentï¼‰
â”œâ”€â”€ setup_bluez_no_pairing.sh # BlueZ é…ç½®è…³æœ¬
â”œâ”€â”€ start_printer_emulator.sh # ä¸€éµå•Ÿå‹•è…³æœ¬
â”œâ”€â”€ config.py                # è¨­å®šæª”
â”œâ”€â”€ escpos_handler.py        # ESC/POS è§£æå™¨
â”œâ”€â”€ printer_response.py      # ç‹€æ…‹å›æ‡‰è™•ç†
â”œâ”€â”€ gatt_server.py           # GATT Server å¯¦ä½œ
â”œâ”€â”€ ble_advertiser.py        # å»£æ’­ç®¡ç†
â”œâ”€â”€ setup.sh                 # ç’°å¢ƒå®‰è£è…³æœ¬
â””â”€â”€ printer_data.log         # æ¥æ”¶è³‡æ–™æ—¥èªŒ
```

---

## ğŸ“ å¾…ç ”ç©¶äº‹é …

1. ~~å¦‚ä½•å®Œå…¨åœç”¨ BlueZ SMP~~ âœ… ä½¿ç”¨ NoInputNoOutput Agent
2. **App çš„å…·é«”æ¡æ‰‹æµç¨‹** - å¯èƒ½éœ€è¦æ“·å–åŸæ©Ÿé€šè¨Š
3. **å»£æ’­å°åŒ…å…§å®¹** - æ˜¯å¦éœ€è¦ Manufacturer Specific Data
4. **ESC/POS å®Œæ•´æŒ‡ä»¤é›†** - åœ–ç‰‡ã€æ¢ç¢¼ã€QR Code ç­‰

---

## ğŸ”— åƒè€ƒè³‡æº

- [BlueZ D-Bus GATT API](https://git.kernel.org/pub/scm/bluetooth/bluez.git/tree/doc/gatt-api.txt)
- [BlueZ Agent API](https://git.kernel.org/pub/scm/bluetooth/bluez.git/tree/doc/agent-api.txt)
- [ESC/POS Command Reference](https://reference.epson-biz.com/modules/ref_escpos/index.php)
- [btmgmt Manual](https://man.archlinux.org/man/btmgmt.1)
- [Pairing Agents in BlueZ](https://technotes.kynetics.com/2018/pairing_agents_bluez/)
- [bluez-peripheral Documentation](https://bluez-peripheral.readthedocs.io/)
